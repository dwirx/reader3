<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#10b981">
    <meta name="mobile-web-app-capable" content="yes">
    <title>{{ book.metadata.title }}</title>
    <link rel="stylesheet" href="/static/reader.css">
</head>
<body>

    <!-- SIDEBAR -->
    <div id="sidebar">
        <button class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle Sidebar">â˜°</button>
        <a href="/" class="nav-home">â† Back to Library</a>
        <div class="nav-header">{{ book.metadata.title }}</div>

        <!-- Recursive Macro for TOC -->
        {% macro render_toc(items) %}
            <ul class="toc-list">
            {% for item in items %}
                <li class="toc-item">
                    {% set is_active = current_chapter.href == item.file_href %}
                    <a href="#" onclick="findAndGo('{{ item.file_href }}', '{{ item.title|replace("'", "\\'") }}'); return false;"
                       class="toc-link {% if is_active %}active{% endif %}"
                       data-href="{{ item.file_href }}"
                       data-title="{{ item.title }}">
                        {{ item.title }}
                    </a>
                    {% if item.children %}
                        {{ render_toc(item.children) }}
                    {% endif %}
                </li>
            {% endfor %}
            </ul>
        {% endmacro %}

        {{ render_toc(book.toc) }}
    </div>

    <!-- MAIN CONTENT -->
    <div id="main">
        <div class="content-container">
            <div class="book-content">
                {{ current_chapter.content | safe }}
            </div>

            <div class="chapter-nav">
                {% if prev_idx is not none %}
                    <a href="/read/{{ book_id }}/{{ prev_idx }}" class="nav-btn">â† Previous</a>
                {% else %}
                    <span class="nav-btn disabled">â† Previous</span>
                {% endif %}

                <span style="color: #999; padding: 10px;">
                    Section {{ chapter_index + 1 }} of {{ book.spine|length }}
                </span>

                {% if next_idx is not none %}
                    <a href="/read/{{ book_id }}/{{ next_idx }}" class="nav-btn">Next â†’</a>
                {% else %}
                    <span class="nav-btn disabled">Next â†’</span>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Toolbar Toggle Button (when hidden) -->
    <button class="toolbar-toggle" onclick="toggleToolbar()" title="Show Toolbar (Ctrl+H)" aria-label="Show toolbar" style="display: none;">
        ğŸŒ
    </button>

    <!-- Translation Toolbar -->
    <div class="translate-toolbar">
        <button class="toolbar-close" onclick="toggleToolbar()" title="Hide Toolbar (Ctrl+H)" aria-label="Close toolbar">
            âœ•
        </button>
        <div class="toolbar-row">
            <select class="provider-select" id="providerSelect" title="Translation Provider">
                <option value="google">ğŸŒ Google</option>
                <option value="zai">ğŸ¤– Z.ai</option>
            </select>
            <select class="lang-select" id="targetLang" title="Target Language">
                <option value="id">ğŸ‡®ğŸ‡© ID</option>
                <option value="en">ğŸ‡¬ğŸ‡§ EN</option>
                <option value="zh-CN">ğŸ‡¨ğŸ‡³ CN</option>
                <option value="ja">ğŸ‡¯ğŸ‡µ JA</option>
                <option value="ko">ğŸ‡°ğŸ‡· KO</option>
                <option value="ar">ğŸ‡¸ğŸ‡¦ AR</option>
                <option value="es">ğŸ‡ªğŸ‡¸ ES</option>
                <option value="fr">ğŸ‡«ğŸ‡· FR</option>
                <option value="de">ğŸ‡©ğŸ‡ª DE</option>
                <option value="ru">ğŸ‡·ğŸ‡º RU</option>
                <option value="pt">ğŸ‡µğŸ‡¹ PT</option>
                <option value="it">ğŸ‡®ğŸ‡¹ IT</option>
                <option value="th">ğŸ‡¹ğŸ‡­ TH</option>
                <option value="vi">ğŸ‡»ğŸ‡³ VI</option>
            </select>
            <button class="translate-btn" id="translateBtn" onclick="translateSelection()" disabled title="Translate selected text">
                <span class="btn-icon">âœ¨</span>
                <span class="btn-text">Text</span>
            </button>
            <button class="translate-page-btn" id="translatePageBtn" onclick="translateFullPage()" title="Translate entire page">
                <span class="btn-icon">ğŸ“„</span>
                <span class="btn-text">Page</span>
            </button>
        </div>
    </div>
    
    <!-- Show Toolbar Button (appears when toolbar is hidden) -->
    <button class="toolbar-toggle" onclick="toggleToolbar()" title="Show Toolbar (Ctrl+H)" aria-label="Show toolbar">
        ğŸŒ
    </button>

    <script>
        // Pass data from backend to JavaScript
        const spineMap = {
            {% for ch in book.spine %}
            "{{ ch.href }}": {{ ch.order }},
            {% endfor %}
        };
        const bookId = "{{ book_id }}";
        
        // Make them globally available
        window.spineMap = spineMap;
        window.bookId = bookId;
    </script>
    
    <!-- Load external JavaScript module -->
    <script src="/static/reader.js"></script>
</body>
</html>
